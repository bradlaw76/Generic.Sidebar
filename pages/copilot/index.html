<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Copilot Host</title>
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <style>
    html,body { margin:0; height:100%; overflow:hidden; background:#fff; }
    #webchat { width:100%; height:100%; }
    #error { font-family:system-ui,Segoe UI,Arial,sans-serif; padding:16px; color:#b00020; }
  </style>
  <!-- Bot Framework Web Chat -->
  <script src="https://cdn.botframework.com/botframework-webchat/latest/webchat.js" crossorigin="anonymous"></script>
</head>
<body>
  <div id="webchat"></div>
  <div id="error" hidden></div>

  <script>
    // --------------------------------------------------------------------
    // 1) PASTE YOUR COPILOT STUDIO "CUSTOM WEBSITE" TOKEN ENDPOINT BELOW
    //    It typically looks like:
    //    https://<env>.<region>.environment.api.powerplatform.com/powervirtualagents/bots/<botId>/directline/token?api-version=...
    //
    // NOTE: Do NOT paste the Microsoft 365 Agents SDK "authenticated conversations"
    // endpoint here. That requires tenant auth and usually won't work from GitHub Pages.
    // --------------------------------------------------------------------
    const TOKEN_ENDPOINT_URL =
      '<<PASTE_YOUR_DIRECTLINE_TOKEN_ENDPOINT_URL_HERE>>';

    // Optional: force a locale if you want (else it uses <html lang> or browser)
    const locale = document.documentElement.lang || 'en-US';

    // Helper: show errors nicely
    function showError(msg) {
      const el = document.getElementById('error');
      el.textContent = msg;
      el.hidden = false;
    }

    (async function init() {
      try {
        if (!window.WebChat) {
          showError('Web Chat script failed to load.');
          return;
        }

        if (!TOKEN_ENDPOINT_URL || TOKEN_ENDPOINT_URL.includes('PASTE_YOUR_DIRECTLINE_TOKEN_ENDPOINT_URL_HERE')) {
          showError('Please set TOKEN_ENDPOINT_URL to your Copilot Studio Direct Line token endpoint.');
          return;
        }

        // Derive API version from the token endpoint query, if present
        const tokenUrl = new URL(TOKEN_ENDPOINT_URL);
        const apiVersion = tokenUrl.searchParams.get('api-version') || '2022-03-01';

        // 2) Discover regional Direct Line URL from Copilot Studio
        const regionalSettingsUrl = new URL(`/powervirtualagents/regionalchannelsettings?api-version=${apiVersion}`, tokenUrl);
        const regionalRes = await fetch(regionalSettingsUrl);
        if (!regionalRes.ok) throw new Error('Failed to retrieve regional channel settings.');
        const { channelUrlsById } = await regionalRes.json();
        const directLineBase = channelUrlsById && channelUrlsById.directline;
        if (!directLineBase) throw new Error('Direct Line base URL not found in regional settings.');

        // 3) Get a Direct Line token (client-safe)
        const tokenRes = await fetch(tokenUrl.toString());
        if (!tokenRes.ok) throw new Error('Failed to retrieve Direct Line token.');
        const tokenJson = await tokenRes.json();
        const token = tokenJson && (tokenJson.token || tokenJson.directLineToken || tokenJson.dlToken);
        if (!token) throw new Error('Token not present in response.');

        // 4) Create Direct Line connection
        const directLine = window.WebChat.createDirectLine({
          domain: new URL('v3/directline', directLineBase).toString(),
          token
        });

        // 5) Send startConversation event ONCE when DL is connected
        const userId = 'gs_' + Math.random().toString(36).slice(2);
        const sub = directLine.connectionStatus$.subscribe({
          next(value) {
            // 2 === 'Online'
            if (value === 2) {
              directLine.postActivity({
                type: 'event',
                name: 'startConversation',
                from: { id: userId },
                locale,
                localTimezone: Intl.DateTimeFormat().resolvedOptions().timeZone
                // value: { entryPoint: 'home' } // optional payload
              }).subscribe({
                complete: () => sub.unsubscribe()
              });
            }
          }
        });

        // 6) Render Web Chat
        const styleOptions = {
          hideUploadButton: true,
          botAvatarInitials: 'VA',   // customize as you like
          userAvatarInitials: 'You'
        };

        window.WebChat.renderWebChat(
          { directLine, locale, styleOptions },
          document.getElementById('webchat')
        );
      } catch (err) {
        console.error(err);
        showError(err.message || String(err));
      }
    })();
  </script>

  <!--
    If you ever want the simplest "no-code" fallback, you can instead use an iframe:
    <iframe src="https://gcc.powerva.microsoft.us/environments/79865a4a-1c0d-e50e-87a2-99bb39150642/bots/cr1ee_genericSidebarAgent_WAojfm/webchat?__version__=2"
            style="width:100%;height:100%;border:0"></iframe>
    But note: you cannot fire 'startConversation' from a plain iframe.
  -->
</body>
</html>
